<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Roboto+Mono:wght@500;700&display=swap');

        :root {
            /* Theme Colors */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --pika-yellow: #facc15;
            --pika-gold: #eab308;
            --pika-accent: #fef9c3;
            
            --text-primary: #111827;
            --text-secondary: #6b7280;
            
            /* Status */
            --col-up: #10b981;
            --col-down: #ef4444;
            --col-flat: #9ca3af;
            
            /* Risk */
            --risk-low: #10b981;
            --risk-med: #f59e0b;
            --risk-high: #ef4444;
            
            /* Sentiment */
            --sent-bull: #ecfdf5; --sent-bull-text: #047857;
            --sent-bear: #fef2f2; --sent-bear-text: #b91c1c;
            --sent-neut: #f3f4f6; --sent-neut-text: #4b5563;

            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html {
            min-height: 100%;
            background-color: var(--bg-color);
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
            overflow-y: auto; 
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 16px;
            padding-bottom: 200px; 
            min-height: 100%;
            background: transparent;
        }

        /* --- Header --- */
        header {
            max-width: 1200px;
            margin: 0 auto 16px auto;
            background: #fff;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--pika-yellow);
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .logo-box {
            width: 48px; height: 48px; background: var(--pika-accent);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: var(--pika-gold); flex-shrink: 0;
        }
        .logo-box svg { width: 28px; height: 28px; filter: drop-shadow(0 2px 2px rgba(234, 179, 8, 0.2)); }
        
        .title-group h1 { 
            margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--text-primary); line-height: 1.1; 
        }
        .title-group h1 span { color: var(--pika-gold); }
        
        .subtitle { 
            font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 4px; 
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        }

        /* Market Badge */
        .market-badge {
            font-size: 0.85rem; padding: 8px 12px; border-radius: 8px; font-weight: 700; 
            text-transform: uppercase; white-space: nowrap; border: 1px solid transparent;
            display: flex; align-items: center; justify-content: center; line-height: 1.2;
        }
        .market-badge.open { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .market-badge.pre { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
        .market-badge.post { background: #f3e8ff; color: #7e22ce; border-color: #e9d5ff; }
        .market-badge.closed { background: #f3f4f6; color: #6b7280; border-color: #e5e7eb; }

        .control-panel { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        /* Select Dropdown */
        select.refresh-select {
            background: #f9fafb; border: 1px solid #d1d5db; padding: 8px 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 700; color: #4b5563;
            outline: none; cursor: pointer;
        }
        select.refresh-select:focus { border-color: var(--pika-yellow); }

        .version-tag {
            font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: #9ca3af; 
            background: #f9fafb; padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-weight: 700;
            line-height: 1.2;
        }

        input[type="text"], input[type="number"] {
            background: #f9fafb; border: 1px solid #d1d5db; padding: 8px 12px;
            border-radius: 8px; font-size: 0.9rem; font-weight: 700;
            text-align: center; outline: none; transition: all 0.2s;
        }
        input:focus { border-color: var(--pika-yellow); background: #fff; }

        .btn {
            border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-weight: 700; font-size: 0.85rem; text-decoration: none; display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        .btn-primary { background: var(--pika-yellow); color: #422006; }
        .btn-primary:hover { background: #fcd34d; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-secondary); }
        
        /* Privacy Toggle Button */
        .btn-privacy { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
        .btn-privacy.active { background: #1f2937; color: #fff; border-color: #374151; }

        /* --- TABS Navigation --- */
        .tabs {
            max-width: 1200px; margin: 0 auto 16px auto; display: flex; gap: 10px;
        }
        .tab-btn {
            padding: 10px 20px; border-radius: 12px; background: #fff; border: 1px solid #e5e7eb;
            font-weight: 700; color: var(--text-secondary); cursor: pointer; flex: 1; text-align: center;
            transition: all 0.2s; font-size: 0.9rem; box-shadow: var(--shadow);
        }
        .tab-btn.active {
            background: var(--text-primary); color: #fff; border-color: var(--text-primary);
        }

        /* --- ASSET PANEL --- */
        .asset-panel {
            max-width: 1200px; margin: 0 auto 24px auto;
            background: #1e293b; 
            border-radius: var(--radius);
            padding: 20px; color: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px; align-items: start;
        }

        .ap-item { display: flex; flex-direction: column; gap: 6px; }
        .ap-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .ap-val { font-family: 'Roboto Mono', monospace; font-size: 1.5rem; font-weight: 700; color: #fff; line-height: 1.2; }
        .ap-sub { font-size: 0.75rem; color: #94a3b8; font-family: 'Roboto Mono', monospace; font-weight: 600;}
        
        .ap-input {
            background: #ffffff; border: 2px solid #e5e7eb; color: #111827;
            width: 100%; max-width: 140px; padding: 10px; text-align: left;
            border-radius: 8px; font-weight: 700; font-family: 'Roboto Mono', monospace;
        }
        .ap-input:focus { border-color: var(--pika-yellow); outline: none; }

        .net-val { color: var(--pika-yellow); text-shadow: 0 0 20px rgba(250, 204, 21, 0.2); }
        .snap-btn { background: #374151; color: #fff; border: 1px solid #475569; font-size: 0.8rem; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: 600;}
        .snap-btn:hover { background: #475569; }

        /* Privacy Mask Class */
        .mask-text { filter: blur(4px); opacity: 0.6; pointer-events: none; user-select: none; }

        /* --- View Containers --- */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- Dashboard Specific --- */
        .ticker-container {
            max-width: 1200px; margin: 0 auto 24px auto; background: #fff; border-radius: 50px;
            padding: 4px; box-shadow: var(--shadow); border: 1px solid #e5e7eb;
            height: 40px; display: flex; align-items: center; overflow: hidden;
        }
        /* Group to hold label and sound button */
        .ticker-left-group {
            display: flex; align-items: center; gap: 6px; padding-left: 4px; margin-right: 10px; z-index: 2; background: #fff;
        }
        .ticker-label {
            background: var(--pika-yellow); color: #422006; font-size: 0.7rem; font-weight: 800;
            padding: 0 12px; height: 30px; border-radius: 40px; display: flex; align-items: center;
            flex-shrink: 0;
        }
        /* Pika Sound Button */
        .sound-btn {
            background: #fef08a; border: 1px solid #facc15; color: #422006;
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 0.9rem; transition: transform 0.1s;
        }
        .sound-btn:active { transform: scale(0.9); }

        .ticker-content { white-space: nowrap; animation: marquee 120s linear infinite; }
        .ticker-item { display: inline-block; margin-right: 30px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .dashboard-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            max-width: 1200px; margin: 0 auto;
        }

        /* --- History & Data Management --- */
        .data-tools {
            max-width: 1200px; margin: 0 auto 20px auto;
            display: flex; gap: 10px; justify-content: flex-end;
        }

        .history-list {
            max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px;
        }
        .history-card {
            background: #fff; border-radius: 12px; padding: 16px 20px; border: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
            box-shadow: var(--shadow);
        }
        .h-time { font-size: 0.8rem; color: #6b7280; font-weight: 600; min-width: 120px; }
        .h-stats { display: flex; gap: 20px; flex: 1; align-items: center; }
        .h-stat-item { display: flex; flex-direction: column; }
        .h-label { font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; font-weight: 700; }
        .h-val { font-family: 'Roboto Mono', monospace; font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .h-val.net { color: #059669; }
        .h-actions { display: flex; gap: 10px; align-items: center; }
        .h-details { width: 100%; border-top: 1px dashed #e5e7eb; margin-top: 10px; padding-top: 10px; display: none; }
        .history-card.open .h-details { display: block; }
        .h-stock-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 4px 0; border-bottom: 1px solid #f9fafb; }
        
        .toggle-btn { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 0.8rem; text-decoration: underline; }
        .del-hist-btn { background: #fee2e2; color: #ef4444; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.75rem; }

        /* --- Stock Card --- */
        .card {
            background: var(--card-bg); border-radius: var(--radius); border: 1px solid #e5e7eb;
            box-shadow: var(--shadow); transition: transform 0.2s; position: relative;
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        .card-top {
            padding: 16px 20px 10px 20px; display: flex; justify-content: space-between; align-items: flex-start;
        }
        
        .stock-info h2 { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        
        .price-group { text-align: right; }
        .price-val { font-family: 'Roboto Mono', monospace; font-size: 1.5rem; font-weight: 700; display: block; line-height: 1.1;}
        .price-change { font-weight: 700; font-size: 0.9rem; display: block; margin-top: 2px;}
        
        .data-meta { display: flex; flex-direction: column; align-items: flex-end; margin-top: 4px; gap: 2px; }
        .data-time { font-size: 0.65rem; color: #9ca3af; font-family: 'Roboto Mono', monospace; }
        
        .stale-badge {
            background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5;
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700;
            display: inline-flex; align-items: center; gap: 3px;
        }

        .delete-btn {
            position: absolute; top: 12px; right: 12px;
            width: 24px; height: 24px; background: #f3f4f6; border-radius: 50%;
            border: none; color: #9ca3af; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .delete-btn:hover { background: #fee2e2; color: #ef4444; }

        .holdings-row {
            background: #f9fafb; padding: 10px 20px; border-top: 1px dashed #e5e7eb; border-bottom: 1px dashed #e5e7eb;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .holdings-input-group { display: flex; align-items: center; gap: 6px; }
        .holdings-label { font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; }
        
        /* FIX 2: Increased Width 1.8x (70px -> 126px) */
        .shares-input { width: 126px; padding: 4px 8px; font-size: 0.85rem; border-radius: 6px; border: 1px solid #d1d5db; }
        
        .holdings-val { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }

        .perf-row {
            display: flex; justify-content: flex-start; gap: 12px;
            padding: 10px 20px; border-bottom: 1px dashed #f3f4f6;
        }
        .perf-item { font-size: 0.7rem; color: var(--text-secondary); font-family: 'Roboto Mono', monospace; font-weight: 500; }
        .perf-val { font-weight: 700; margin-left: 2px; }

        .risk-box { margin: 12px 20px 16px 20px; padding: 12px; border-radius: 12px; background: #f9fafb; border: 1px solid #f3f4f6; }
        .risk-header { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .progress-bg { height: 6px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        .metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #e5e7eb; background: #fafafa; margin-top: auto; }
        .metric { padding: 10px; text-align: center; border-right: 1px solid #e5e7eb; }
        .metric:last-child { border-right: none; }
        .m-label { font-size: 0.65rem; color: #9ca3af; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .m-val { font-size: 0.9rem; font-weight: 700; color: var(--text-primary); font-family: 'Roboto Mono', monospace; }

        .text-up { color: var(--col-up); } .text-down { color: var(--col-down); } .text-flat { color: var(--col-flat); }
        
        /* Pokeball Loader */
        .loader { 
            position: absolute; inset: 0; background: rgba(255,255,255,0.9); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; 
        }
        .pokeball {
            width: 40px; height: 40px; background: #fff;
            border: 3px solid #333; border-radius: 50%;
            position: relative; overflow: hidden;
            animation: shake 1.5s infinite ease-in-out;
        }
        .pokeball::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: #ef4444; border-bottom: 3px solid #333;
        }
        .pokeball::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; background: #fff; border: 3px solid #333; border-radius: 50%; z-index: 2;
        }
        .loading-text { font-size: 0.7rem; font-weight: 700; color: #6b7280; margin-top: 8px; }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            60% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }

        @media (max-width: 768px) {
            header { flex-direction: column; align-items: stretch; padding: 16px; gap: 12px; }
            .header-left { justify-content: center; }
            .control-panel { justify-content: center; width: 100%; }
            .control-panel input { width: 80px; }
            .asset-panel { grid-template-columns: 1fr; gap: 16px; }
            .dashboard-grid { grid-template-columns: 1fr; } 
            .perf-row { justify-content: space-between; }
            .h-stats { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                </svg>
            </div>
            <div class="title-group">
                <h1>Wall Street <span>Pika</span></h1>
                <div class="subtitle">Mini Dashboard</div>
            </div>
        </div>

        <div class="control-panel">
            <span class="version-tag">v2.6</span>
            <!-- Market Status -->
            <div id="global-status"></div>
            
            <!-- Refresh Rate Selector (Default 2s) -->
            <select class="refresh-select" onchange="changeRefreshRate(this.value)">
                <option value="2000" selected>‚è±Ô∏è 2s</option>
                <option value="3000">‚è±Ô∏è 3s</option>
                <option value="5000">‚è±Ô∏è 5s</option>
                <option value="10000">‚è±Ô∏è 10s</option>
                <option value="30000">‚è±Ô∏è 30s</option>
                <option value="0">‚è±Ô∏è STOP</option>
            </select>

            <!-- Privacy Toggle -->
            <button class="btn btn-privacy" id="privacy-btn" onclick="togglePrivacy()" title="Privacy Mode">
                üëÅÔ∏è
            </button>

            <a href="https://sites.google.com/view/wallstreetpikabible/" target="_blank" class="btn btn-outline">
                üìñ ËÅñÁ∂ì
            </a>
            <input type="text" id="new-stock-input" placeholder="NVDA" maxlength="5">
            <button class="btn btn-primary" onclick="addNewStock()">+</button>
        </div>
    </header>

    <!-- NEW TABS -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab-btn" onclick="switchTab('history')">History & Backup</div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="view-section active">
        <!-- ASSET PANEL -->
        <div class="asset-panel">
            <div class="ap-item">
                <span class="ap-label">Total (HKD)</span>
                <span class="ap-val p-mask" id="total-assets">HK$ --</span>
                <span class="ap-sub">Rate: <span id="fx-rate">7.78</span> (USD/HKD)</span>
            </div>
            <div class="ap-item">
                <span class="ap-label">Loan (HKD)</span>
                <input type="number" id="loan-input" class="ap-input" placeholder="0" onchange="updateLoan(this.value)">
            </div>
            <div class="ap-item">
                <span class="ap-label">Net Equity</span>
                <span class="ap-val net-val p-mask" id="net-value">HK$ --</span>
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <span class="ap-sub" id="lev-display">Lev: --</span>
                    <button class="snap-btn" onclick="takeSnapshot()">üì∑ Snap</button>
                </div>
            </div>
        </div>

        <div class="ticker-container">
            <div class="ticker-left-group">
                <div class="ticker-label">PIKA WISDOM</div>
                <button class="sound-btn" onclick="playPika()" title="Pika!">üîä</button>
            </div>
            <div class="ticker-content" id="ticker-content"></div>
        </div>

        <div class="dashboard-grid" id="app"></div>
    </div>

    <!-- VIEW: HISTORY -->
    <div id="view-history" class="view-section">
        <div class="data-tools">
            <button class="btn btn-outline" onclick="exportData()">‚¨áÔ∏è Export Data</button>
            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Import Data</button>
            <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">
        </div>

        <div class="history-list" id="history-container">
            <!-- JS populated -->
            <div style="text-align:center; color:#9ca3af; padding:40px;">No snapshots yet.</div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 40px; margin-bottom: 20px; color: #9ca3af; font-size: 0.75rem;">
        Mini Dashboard
    </div>

    <script>
        const API_KEY = 'd62qgopr01qnpu82ah0gd62qgopr01qnpu82ah10';
        // --- DATA MIGRATION LOGIC (V2.6) ---
        // New key for v2.6
        const STORAGE_KEY = 'pika_stocks_v2_6'; 
        // List of previous keys to check for migration
        const LEGACY_KEYS = ['pika_stocks_v2_5', 'pika_stocks_v2_3', 'pika_stocks_v2_2', 'pika_stocks_v2_1'];
        
        // Default Config
        const DEFAULT_STOCKS = [
            { symbol: 'KEN', beta: 1.5, shares: 0 }, 
            { symbol: 'TSLA', beta: 2.4, shares: 0 }, 
            { symbol: 'UPST', beta: 2.8, shares: 0 }
        ];

        // State
        let marketData = [];
        let loanAmount = 0;
        let usdHkdRate = 7.78; 
        let snapshots = [];
        let isPrivacy = false; 
        let refreshIntervalId = null;
        let refreshDelay = 2000; // FIX: Default 2s

        // --- Pika Sound Logic ---
        function playPika() {
            if (!window.speechSynthesis) return;
            const speak = () => {
                const u = new SpeechSynthesisUtterance("Pika Pika!");
                u.pitch = 1.8; u.rate = 1.4; u.volume = 1;
                window.speechSynthesis.speak(u);
            };
            speak(); setTimeout(speak, 800); setTimeout(speak, 1600);
        }

        // --- Logic ---
        function initTicker() {
            const quotes = [
                "ËÉΩÂ§†Ëá™Áî±Ëá™Âú∞ÈÅéËëóÁ¨¶ÂêàËá™Â∑±ÁöÑÁÜ±Âø±ÂíåÁâπË≥™ÁöÑ‰∫∫ÁîüÔºåÂ§ßÊ¶ÇÂ∞±ÊòØÈáëÈå¢ÂèØ‰ª•Ë≤∑Âà∞ÁöÑÊúÄÂ§ßÂ•¢‰æàÂìÅ„ÄÇ",
                "‰∏ÄËº©Â≠êÊäìËëóÂπæÂÄãÊ©üÊúÉÔºåËøÖÈÄüË°åÂãïÔºåÂéªÂÅöÁ∞°ÂñÆÂèàÂêà‰πéÈÇèËºØÁöÑ‰∫ãÊÉÖÔºåÂ∞±ËÉΩÂæóÂà∞ÂæàÂ§ßÁöÑË≤°ÂØå„ÄÇ",
                "Ë≥∫Èå¢ÊòØÁÇ∫‰∫ÜÊõ¥Â•ΩÁöÑÁîüÊ¥ªÔºåÊàëÂÄëÂçªÂú®Ë≥∫Èå¢ÁöÑÈÅéÁ®ã‰∏≠ÈåØÈÅé‰∫ÜÁîüÊ¥ª",
                "Áü≠ÊúüÂÖßÂ∏ÇÂ†¥ÊòØÊäïÁ•®Ê©üÔºåÈï∑Êúü‰æÜÊòØ‰∏ÄÂè∞Á®±ÈáçÊ©ü",
                "ÊúÄÈáçË¶ÅÁöÑÊòØËÄêÊÄßÔºå‰∫§ÊòìÊ±∫Á≠ñÂÆúÁ∑©‰∏çÂÆúÊÄ•„ÄÇ"
            ];
            const el = document.getElementById('ticker-content');
            if (el) el.innerHTML = quotes.map(q => `<span class="ticker-item">‚òÖ ${q}</span>`).join('');
        }

        function getNyDateString(dateObj) {
            return new Intl.DateTimeFormat('en-US', { 
                timeZone: 'America/New_York', year: 'numeric', month: 'numeric', day: 'numeric' 
            }).format(dateObj);
        }

        function getMarketState() {
            const now = new Date();
            const nyTimeStr = now.toLocaleString("en-US", {timeZone: "America/New_York"});
            const nyTime = new Date(nyTimeStr);
            const day = nyTime.getDay();
            const hour = nyTime.getHours();
            const min = nyTime.getMinutes();
            const timeVal = hour + min/60;

            if (day === 0 || day === 6) return { code: 'CLOSED', label: 'MARKET CLOSED', color: 'closed' };
            if (timeVal >= 4 && timeVal < 9.5) return { code: 'PRE', label: 'PRE-MARKET', color: 'pre' };
            if (timeVal >= 9.5 && timeVal < 16) return { code: 'OPEN', label: 'MARKET OPEN', color: 'open' };
            if (timeVal >= 16 && timeVal < 20) return { code: 'POST', label: 'POST-MARKET', color: 'post' };
            return { code: 'CLOSED', label: 'MARKET CLOSED', color: 'closed' };
        }

        function updateGlobalStatus() {
            const state = getMarketState();
            const el = document.getElementById('global-status');
            if(el) el.innerHTML = `<span class="market-badge ${state.color}">${state.label}</span>`;
        }

        function generatePerfStats(volatility) {
            const v = volatility || 'High';
            const mult = (v === 'Extreme' ? 4 : 2);
            const r = () => (Math.random() * 10 - 4) * mult; 
            return { d7: r().toFixed(1), d14: (r()*1.5).toFixed(1), d30: (r()*2).toFixed(1) };
        }

        // --- IMPORT / EXPORT FUNCTIONS ---
        function exportData() {
            const data = {
                version: "2.6",
                date: new Date().toISOString(),
                stocks: marketData,
                loan: loanAmount,
                snapshots: snapshots,
                privacy: isPrivacy
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pika_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.stocks && Array.isArray(data.stocks)) {
                        marketData = data.stocks;
                        loanAmount = data.loan || 0;
                        snapshots = data.snapshots || [];
                        isPrivacy = data.privacy || false;
                        
                        marketData.forEach(s => { s.loading = true; if(!s.perf) s.perf = generatePerfStats('High'); });
                        saveData();
                        
                        // FIX: Explicitly update UI and Fetch after import
                        updatePrivacyUI(); 
                        document.getElementById('loan-input').value = loanAmount;
                        render(); 
                        renderHistory();
                        fetchData(); 
                        alert('Data Imported Successfully!');
                    } else {
                        throw new Error("Invalid Format");
                    }
                } catch (err) { alert('Error: Invalid Backup File'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- Storage Engine ---
        const SmartStorage = {
            save: function(data, loan, snaps, privacy) {
                const payload = {
                    stocks: data.map(s => ({ symbol: s.symbol, beta: s.beta || 1.2, perf: s.perf, shares: s.shares || 0 })),
                    loan: loan || 0,
                    snapshots: snaps || [],
                    privacy: privacy
                };
                const json = JSON.stringify(payload);
                try { localStorage.setItem(STORAGE_KEY, json); } catch(e){}
                try { sessionStorage.setItem(STORAGE_KEY, json); } catch(e){}
                try { window.name = json; } catch(e){}
            },
            load: function() {
                // 1. Try Load Current Key
                let json = null;
                try { json = localStorage.getItem(STORAGE_KEY); } catch(e){}
                if(!json) try { json = sessionStorage.getItem(STORAGE_KEY); } catch(e){}
                if(!json && window.name && window.name.startsWith('{')) { try { json = window.name; } catch(e){} }
                
                if (json) return JSON.parse(json);

                // 2. Migration: Try Legacy Keys if current is empty
                for (let key of LEGACY_KEYS) {
                    try {
                        let oldJson = localStorage.getItem(key) || sessionStorage.getItem(key);
                        if (oldJson) {
                            console.log("Migrating from " + key);
                            const parsed = JSON.parse(oldJson);
                            // Auto-save to new key to complete migration
                            this.save(
                                parsed.stocks || parsed, 
                                parsed.loan || 0, 
                                parsed.snapshots || [], 
                                parsed.privacy || false
                            );
                            return parsed;
                        }
                    } catch(e) {}
                }

                return null;
            }
        };

        function loadStocks() {
            const saved = SmartStorage.load();
            if (saved && (saved.stocks || Array.isArray(saved))) {
                // Handle different structures from old versions
                const dataRaw = saved.stocks || saved; 
                if (Array.isArray(dataRaw)) {
                    marketData = dataRaw;
                    loanAmount = saved.loan || 0;
                    snapshots = saved.snapshots || [];
                    isPrivacy = saved.privacy || false;
                    marketData.forEach(s => {
                        if (!s.perf) s.perf = generatePerfStats('High');
                        s.loading = true; 
                    });
                }
            } else {
                marketData = JSON.parse(JSON.stringify(DEFAULT_STOCKS));
                marketData.forEach(s => { s.perf = generatePerfStats('High'); s.loading = true; });
                loanAmount = 0;
                snapshots = [];
            }
            
            document.getElementById('loan-input').value = loanAmount;
            
            // Apply Privacy State to UI
            updatePrivacyUI();
            
            render();
            fetchData(); // Initial fetch
            fetchFxRate();
            startRefreshTimer(); // Start Auto Refresh
        }

        function saveData() {
            SmartStorage.save(marketData, loanAmount, snapshots, isPrivacy);
            calculateAssets();
        }

        function addNewStock() {
            const input = document.getElementById('new-stock-input');
            const sym = input.value.trim().toUpperCase();
            if (!sym || marketData.find(s => s.symbol === sym)) return;
            const newStock = { symbol: sym, beta: 1.5, loading: true, perf: generatePerfStats('Medium'), shares: 0 };
            marketData.push(newStock);
            saveData();
            input.value = '';
            render();
            fetchSingle(newStock);
        }

        function removeStock(sym) {
            marketData = marketData.filter(s => s.symbol !== sym);
            saveData();
            render();
        }

        function updateShares(sym, val) {
            const stock = marketData.find(s => s.symbol === sym);
            if (stock) {
                stock.shares = parseFloat(val) || 0;
                saveData();
                render(); 
            }
        }

        function updateLoan(val) {
            loanAmount = parseFloat(val) || 0;
            saveData();
        }

        // --- FIX 1: Privacy Toggle Logic ---
        function togglePrivacy() {
            isPrivacy = !isPrivacy;
            updatePrivacyUI();
            saveData();
            render(); // Re-render to mask/unmask card values
        }

        function updatePrivacyUI() {
            const btn = document.getElementById('privacy-btn');
            const loanInput = document.getElementById('loan-input');
            
            if (isPrivacy) {
                btn.classList.add('active');
                loanInput.type = "password"; // Mask input
            } else {
                btn.classList.remove('active');
                loanInput.type = "number"; // Unmask
            }
            calculateAssets(); // Update masking on total panel
        }

        // --- FIX 3: Auto Refresh Logic ---
        function changeRefreshRate(val) {
            refreshDelay = parseInt(val);
            startRefreshTimer();
        }

        function startRefreshTimer() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            if (refreshDelay > 0) {
                refreshIntervalId = setInterval(fetchData, refreshDelay);
            }
        }

        // --- FX & Asset Logic ---
        async function fetchFxRate() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                if (data && data.rates && data.rates.HKD) {
                    usdHkdRate = data.rates.HKD;
                    document.getElementById('fx-rate').innerText = usdHkdRate.toFixed(3);
                    calculateAssets();
                }
            } catch(e) { console.log('FX Error, using default'); }
        }

        function calculateAssets() {
            let totalUsd = 0;
            marketData.forEach(s => {
                const price = s.currentPrice || 0;
                const qty = s.shares || 0;
                totalUsd += price * qty;
            });

            const totalHkd = totalUsd * usdHkdRate;
            const netHkd = totalHkd - loanAmount;
            
            let lev = 0;
            if (netHkd > 0) { lev = (totalHkd / netHkd); } 
            else if (totalHkd > 0) { lev = 999; }

            // Display Logic with Privacy Check
            const totalEl = document.getElementById('total-assets');
            const netEl = document.getElementById('net-value');
            
            if (isPrivacy) {
                totalEl.innerText = "HK$ ****";
                netEl.innerText = "HK$ ****";
                totalEl.classList.add('mask-text'); // Add blur class if you want, or just stars
                netEl.classList.add('mask-text');
            } else {
                totalEl.innerText = 'HK$ ' + Math.round(totalHkd).toLocaleString();
                netEl.innerText = 'HK$ ' + Math.round(netHkd).toLocaleString();
                totalEl.classList.remove('mask-text');
                netEl.classList.remove('mask-text');
            }
            
            const levStr = lev === 999 ? "Risk" : lev.toFixed(2) + "x";
            const levEl = document.getElementById('lev-display');
            levEl.innerText = "Lev: " + levStr;
            
            if(lev > 1.5) levEl.style.color = '#f87171'; 
            else if(lev > 1.2) levEl.style.color = '#fbbf24'; 
            else levEl.style.color = '#94a3b8'; 
            
            return { total: totalHkd, net: netHkd, lev: levStr };
        }

        // --- Snapshot Logic ---
        function takeSnapshot() {
            const now = new Date();
            const timeStr = now.toLocaleString("zh-HK", { hour12: false });
            const assets = calculateAssets(); // Note: this might return stars if privacy is on!
            
            // To save real values in snapshot even if privacy is on, we recalculate internally
            let totalUsd = 0;
            marketData.forEach(s => { totalUsd += (s.currentPrice || 0) * (s.shares || 0); });
            const realTotal = totalUsd * usdHkdRate;
            const realNet = realTotal - loanAmount;
            
            const snap = {
                id: Date.now(),
                time: timeStr,
                net: Math.round(realNet).toLocaleString(),
                total: Math.round(realTotal).toLocaleString(),
                loan: Math.round(loanAmount).toLocaleString(),
                lev: assets.lev, 
                details: marketData.map(s => ({
                    sym: s.symbol,
                    shares: s.shares || 0,
                    price: s.currentPrice || 0
                }))
            };
            
            snapshots.unshift(snap); 
            if(snapshots.length > 20) snapshots.pop(); 
            saveData();
            
            if(document.getElementById('view-history').classList.contains('active')) {
                renderHistory();
            }
            alert('Snapshot Saved!');
        }

        function deleteSnapshot(id) {
            if(!confirm('Delete this record?')) return;
            snapshots = snapshots.filter(s => s.id !== id);
            saveData();
            renderHistory();
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(tab === 'dashboard') btns[0].classList.add('active');
            else {
                btns[1].classList.add('active');
                renderHistory();
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(snapshots.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:40px;">No snapshots yet.</div>';
                return;
            }
            container.innerHTML = snapshots.map(s => `
                <div class="history-card" onclick="this.classList.toggle('open')">
                    <div class="h-time">${s.time}</div>
                    <div class="h-stats">
                        <div class="h-stat-item">
                            <span class="h-label">Net Asset</span>
                            <span class="h-val net">HK$ ${s.net}</span>
                        </div>
                        <div class="h-stat-item">
                            <span class="h-label">Lev</span>
                            <span class="h-val" style="font-size:0.9rem">${s.lev || '-'}</span>
                        </div>
                    </div>
                    <div class="h-actions">
                        <button class="toggle-btn">Details</button>
                        <button class="del-hist-btn" onclick="event.stopPropagation(); deleteSnapshot(${s.id})">‚úï</button>
                    </div>
                    <div class="h-details" onclick="event.stopPropagation()">
                        <div class="h-stock-row" style="font-weight:700; color:#6b7280;">
                            <span>Stock</span><span>Price(USD)</span><span>Shares</span>
                        </div>
                        ${s.details.map(d => `
                            <div class="h-stock-row">
                                <span>${d.sym}</span>
                                <span>$${d.price.toFixed(2)}</span>
                                <span>${d.shares}</span>
                            </div>
                        `).join('')}
                        <div class="h-stock-row" style="margin-top:8px; font-weight:700;">
                            <span>Loan</span><span></span><span>- HK$ ${s.loan}</span>
                        </div>
                        <div class="h-stock-row" style="margin-top:4px; font-weight:700;">
                            <span>Total Asset</span><span></span><span>HK$ ${s.total}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Fetch Data ---
        async function fetchData() {
            updateGlobalStatus();
            for (let stock of marketData) {
                fetchSingle(stock);
                // We do NOT use await here heavily to allow fast concurrent updates if interval is short
            }
        }

        async function fetchSingle(stock) {
            try {
                const bust = Date.now();
                const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stock.symbol}&token=${API_KEY}&_=${bust}`);
                const data = await res.json();

                if (data.c) {
                    stock.prevClose = data.pc; 
                    stock.lastUpdate = data.t;
                    stock.loading = false;

                    const todayNyStr = getNyDateString(new Date()); 
                    const dataNyStr = getNyDateString(new Date(data.t * 1000));
                    stock.isStale = (dataNyStr !== todayNyStr);

                    if (stock.isStale) {
                        stock.currentPrice = data.c; 
                        stock.changePercent = data.dp; 
                    } else {
                        stock.currentPrice = data.c;
                        if (data.pc > 0) {
                            stock.changePercent = ((data.c - data.pc) / data.pc) * 100;
                        } else {
                            stock.changePercent = data.dp;
                        }
                    }

                    if(stock.perf) {
                        stock.perf.d7 = (parseFloat(stock.perf.d7) + stock.changePercent * 0.05).toFixed(1);
                    }

                    let base = 50 + (stock.changePercent * 2);
                    stock.rsi = Math.min(Math.max(base + (Math.random()*4-2), 10), 90);
                    
                    calculateAssets(); 
                    
                    // Specific re-render of this card might be more efficient, but render() is fast enough
                    render(); 
                }
            } catch (e) { console.error(e); }
        }

        function calculateRisk(stock) {
            let score = 0;
            const beta = stock.beta || 1.2;
            if (beta > 2.0) score += 30; else if (beta > 1.5) score += 20; else score += 10;
            const rsi = stock.rsi || 50;
            if (rsi > 75 || rsi < 25) score += 20;
            const absChg = Math.abs(stock.changePercent || 0);
            if (absChg > 5.0) score += 30; else if (absChg > 2.0) score += 15;
            return Math.min(Math.max(Math.round(score), 5), 100);
        }

        function getSign(val) { return parseFloat(val) > 0 ? '+' : ''; }
        function getColor(val) { return parseFloat(val) >= 0 ? 'text-up' : 'text-down'; }

        function render() {
            const container = document.getElementById('app');
            const state = getMarketState();

            container.innerHTML = marketData.map(stock => {
                const p = stock.currentPrice ? stock.currentPrice.toFixed(2) : '--';
                const cp = stock.changePercent ? stock.changePercent.toFixed(2) : '0.00';
                
                let cClass = stock.changePercent >= 0 ? 'text-up' : 'text-down';
                if (stock.isStale) cClass = 'text-flat'; 
                
                const sign = stock.changePercent >= 0 ? '+' : '';
                
                let timeDisplay = '--:--';
                if (stock.lastUpdate) {
                    timeDisplay = new Date(stock.lastUpdate * 1000).toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});
                }
                
                let timeHtml = `<div class="data-meta"><span class="data-time">Update: ${timeDisplay} ET</span></div>`;
                if (stock.isStale) {
                    if (state.code !== 'CLOSED') {
                        timeHtml = `
                        <div class="data-meta">
                            <span class="stale-badge">‚ö†Ô∏è Waiting for trade</span>
                            <span class="data-time">Last: ${timeDisplay}</span>
                        </div>`;
                    } else {
                        timeHtml = `<div class="data-meta"><span class="data-time">Closed: ${timeDisplay}</span></div>`;
                    }
                }

                let riskScore = calculateRisk(stock);
                let riskColor = 'var(--risk-med)';
                let riskLabel = 'HOLD';
                if(riskScore < 35) { riskColor = 'var(--risk-low)'; riskLabel = 'SAFE'; }
                if(riskScore > 65) { riskColor = 'var(--risk-high)'; riskLabel = 'HIGH RISK'; }

                const perf = stock.perf || { d7: 0, d14: 0, d30: 0 };
                
                const shares = stock.shares || 0;
                const priceVal = stock.currentPrice || 0;
                const holdingValUsd = shares * priceVal;
                const holdingValHkd = holdingValUsd * usdHkdRate;
                
                // Privacy Masking Logic for Card
                let holdingDisplay = `HK$ ${Math.round(holdingValHkd).toLocaleString()}`;
                let sharesInputType = "number";
                
                if (isPrivacy) {
                    holdingDisplay = "HK$ ****";
                    sharesInputType = "password";
                }

                const loadingHtml = stock.loading ? `
                    <div class="loader">
                        <div class="pokeball"></div>
                        <div class="loading-text">ËºâÂÖ•‰∏≠...</div>
                    </div>` : '';

                return `
                <div class="card">
                    ${loadingHtml}
                    <button class="delete-btn" onclick="removeStock('${stock.symbol}')">‚úï</button>
                    
                    <div class="card-top">
                        <div class="stock-info">
                            <span class="market-tag ${state.color}">${state.code}</span>
                            <h2>${stock.symbol}</h2>
                        </div>
                        <div class="price-group">
                            <span class="price-val">$${p}</span>
                            <span class="price-change ${cClass}">${sign}${cp}%</span>
                            ${timeHtml}
                        </div>
                    </div>

                    <div class="holdings-row">
                        <div class="holdings-input-group">
                            <span class="holdings-label">Shares</span>
                            <input type="${sharesInputType}" class="shares-input" value="${shares}" onchange="updateShares('${stock.symbol}', this.value)">
                        </div>
                        <div class="holdings-val ${isPrivacy?'mask-text':''}">
                            ${holdingDisplay}
                        </div>
                    </div>

                    <div class="perf-row">
                        <div class="perf-item">7D: <span class="perf-val ${getColor(perf.d7)}">${getSign(perf.d7)}${perf.d7}%</span></div>
                        <div class="perf-item">14D: <span class="perf-val ${getColor(perf.d14)}">${getSign(perf.d14)}${perf.d14}%</span></div>
                        <div class="perf-item">30D: <span class="perf-val ${getColor(perf.d30)}">${getSign(perf.d30)}${perf.d30}%</span></div>
                    </div>

                    <div class="risk-box">
                        <div class="risk-header">
                            <span>Risk Score</span>
                            <span style="color:${riskColor}">${riskScore} / 100</span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-fill" style="width:${riskScore}%; background:${riskColor}"></div>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric">
                            <span class="m-label">RSI</span>
                            <span class="m-val">${stock.rsi ? stock.rsi.toFixed(0) : '--'}</span>
                        </div>
                        <div class="metric">
                            <span class="m-label">Beta</span>
                            <span class="m-val">${stock.beta || 1.2}</span>
                        </div>
                        <div class="metric">
                            <span class="m-label">Verdict</span>
                            <span class="m-val" style="color:${riskColor}; font-size:0.8rem">${riskLabel}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        initTicker();
        loadStocks();
        setInterval(updateGlobalStatus, 60000);

    </script>
</body>
</html>
