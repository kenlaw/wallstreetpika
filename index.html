<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23facc15' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><path d='M13 2L3 14h9l-1 8 10-12h-9l1-8z'/></svg>" type="image/svg+xml">
    <title>Mini Stock Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Roboto+Mono:wght@500;700&display=swap');

        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --pika-yellow: #facc15;
            --pika-gold: #eab308;
            --pika-accent: #fef9c3;
            
            --text-primary: #111827;
            --text-secondary: #6b7280;
            
            --col-up: #10b981;
            --col-down: #ef4444;
            --col-flat: #9ca3af;
            
            --risk-low: #10b981;
            --risk-med: #f59e0b;
            --risk-high: #ef4444;

            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html {
            min-height: 100%;
            background-color: var(--bg-color);
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
            overflow-y: auto; 
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 16px;
            padding-bottom: 200px; 
            min-height: 100%;
            background: transparent;
        }

        /* --- WELCOME SCREEN --- */
        #welcome-screen {
            position: fixed; inset: 0; background: #fff; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            padding: 20px; text-align: center;
            cursor: pointer; /* Indicates clickable */
        }
        #welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .welcome-img {
            max-width: 100%; max-height: 50vh; border-radius: 16px; 
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px; 
            /* Border removed */
        }
        
        /* Updated: Dark Grey instead of Orange */
        .welcome-quote {
            font-size: 1.2rem; font-weight: 700; color: #374151; 
            margin-bottom: 10px;
        }
        
        /* New Countdown Text Style (No Button) */
        .countdown-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            color: #9ca3af;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        /* --- Header --- */
        header {
            max-width: 1200px;
            margin: 0 auto 16px auto;
            background: #fff;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--pika-yellow);
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .logo-box {
            width: 48px; height: 48px; background: var(--pika-accent);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: var(--pika-gold); flex-shrink: 0;
        }
        .logo-box svg { width: 28px; height: 28px; filter: drop-shadow(0 2px 2px rgba(234, 179, 8, 0.2)); }
        
        .title-group h1 { 
            margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--text-primary); line-height: 1.1; 
        }
        .title-group h1 span { color: var(--pika-gold); }
        
        .subtitle { 
            font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 4px; 
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        }

        /* New Profile Pic Style */
        .profile-pic {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #CCCCCC;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 4px;
            zoom: 120%;
        }

        .market-badge {
            font-size: 0.85rem; padding: 8px 12px; border-radius: 8px; font-weight: 700; 
            text-transform: uppercase; white-space: nowrap; border: 1px solid transparent;
            display: flex; align-items: center; justify-content: center; line-height: 1.2;
        }
        .market-badge.open { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .market-badge.pre { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
        .market-badge.post { background: #f3e8ff; color: #7e22ce; border-color: #e9d5ff; }
        .market-badge.closed { background: #f3f4f6; color: #6b7280; border-color: #e5e7eb; }

        .control-panel { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        select.refresh-select {
            background: #f9fafb; border: 1px solid #d1d5db; padding: 8px 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 700; color: #4b5563;
            outline: none; cursor: pointer;
        }
        select.refresh-select:focus { border-color: var(--pika-yellow); }

        .version-tag {
            font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: #9ca3af; 
            background: #f9fafb; padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-weight: 700;
            line-height: 1.2;
        }
        
        /* API Status Tag Styling */
        .api-tag {
            font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: #fff; 
            background: #6b7280; padding: 6px 10px; border-radius: 8px; font-weight: 600;
            line-height: 1.5; min-width: 80px; text-align: center;
        }
        .api-tag.active { background: #f59e0b; color: #fff; animation: pulse-api 1s infinite; }
        @keyframes pulse-api { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        input[type="text"], input[type="number"] {
            background: #f9fafb; border: 1px solid #d1d5db; padding: 8px 12px;
            border-radius: 8px; font-size: 0.9rem; font-weight: 700;
            text-align: center; outline: none; transition: all 0.2s;
        }
        input:focus { border-color: var(--pika-yellow); background: #fff; }

        .btn {
            border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-weight: 700; font-size: 0.85rem; text-decoration: none; display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        .btn-primary { background: var(--pika-yellow); color: #422006; }
        .btn-primary:hover { background: #fcd34d; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-secondary); }
        .btn-privacy { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
        .btn-privacy.active { background: #1f2937; color: #fff; border-color: #374151; }

        .tabs { max-width: 1200px; margin: 0 auto 16px auto; display: flex; gap: 10px; }
        .tab-btn {
            padding: 10px 20px; border-radius: 12px; background: #fff; border: 1px solid #e5e7eb;
            font-weight: 700; color: var(--text-secondary); cursor: pointer; flex: 1; text-align: center;
            transition: all 0.2s; font-size: 0.9rem; box-shadow: var(--shadow);
        }
        .tab-btn.active { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }

        .asset-panel {
            max-width: 1200px; margin: 0 auto 24px auto;
            background: #1e293b; border-radius: var(--radius); padding: 20px; color: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px; align-items: start;
        }
        .ap-item { display: flex; flex-direction: column; gap: 6px; }
        .ap-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .ap-val { font-family: 'Roboto Mono', monospace; font-size: 1.5rem; font-weight: 700; color: #fff; line-height: 1.2; }
        .ap-sub { font-size: 0.75rem; color: #94a3b8; font-family: 'Roboto Mono', monospace; font-weight: 600;}
        .ap-input {
            background: #ffffff; border: 2px solid #e5e7eb; color: #111827; width: 100%; max-width: 140px; padding: 10px;
            text-align: left; border-radius: 8px; font-weight: 700; font-family: 'Roboto Mono', monospace;
        }
        .net-val { color: var(--pika-yellow); text-shadow: 0 0 20px rgba(250, 204, 21, 0.2); }
        .snap-btn { background: #374151; color: #fff; border: 1px solid #475569; font-size: 0.8rem; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: 600;}
        
        .mask-text { filter: blur(4px); opacity: 0.6; pointer-events: none; user-select: none; }
        .view-section { display: none; } .view-section.active { display: block; }

        .ticker-container {
            max-width: 1200px; margin: 0 auto 24px auto; background: #fff; border-radius: 50px;
            padding: 4px; box-shadow: var(--shadow); border: 1px solid #e5e7eb;
            height: 40px; display: flex; align-items: center; overflow: hidden;
        }
        .ticker-left-group { display: flex; align-items: center; gap: 6px; padding-left: 4px; margin-right: 10px; z-index: 2; background: #fff; }
        .ticker-label {
            background: var(--pika-yellow); color: #422006; font-size: 0.7rem; font-weight: 800;
            padding: 0 12px; height: 30px; border-radius: 40px; display: flex; align-items: center;
            flex-shrink: 0;
        }
        .sound-btn {
            background: #fef08a; border: 1px solid #facc15; color: #422006; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; transition: transform 0.1s;
        }
        .sound-btn:active { transform: scale(0.9); }
        .ticker-content { white-space: nowrap; animation: marquee 120s linear infinite; }
        .ticker-item { display: inline-block; margin-right: 30px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .data-tools { max-width: 1200px; margin: 0 auto 20px auto; display: flex; gap: 10px; justify-content: flex-end; }
        .history-list { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
        .history-card { background: #fff; border-radius: 12px; padding: 16px 20px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; box-shadow: var(--shadow); }
        .h-time { font-size: 0.8rem; color: #6b7280; font-weight: 600; min-width: 120px; }
        .h-stats { display: flex; gap: 20px; flex: 1; align-items: center; }
        .h-stat-item { display: flex; flex-direction: column; }
        .h-label { font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; font-weight: 700; }
        .h-val { font-family: 'Roboto Mono', monospace; font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .h-val.net { color: #059669; }
        .h-actions { display: flex; gap: 10px; align-items: center; }
        .h-details { width: 100%; border-top: 1px dashed #e5e7eb; margin-top: 10px; padding-top: 10px; display: none; }
        .history-card.open .h-details { display: block; }
        .h-stock-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 4px 0; border-bottom: 1px solid #f9fafb; }
        .toggle-btn { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 0.8rem; text-decoration: underline; }
        .del-hist-btn { background: #fee2e2; color: #ef4444; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.75rem; }

        /* Card */
        .card { background: var(--card-bg); border-radius: var(--radius); border: 1px solid #e5e7eb; box-shadow: var(--shadow); transition: transform 0.2s; position: relative; display: flex; flex-direction: column; overflow: visible; min-height: auto; }
        .card-top { padding: 16px 20px 10px 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stock-info h2 { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        .price-group { text-align: right; }
        .price-val { font-family: 'Roboto Mono', monospace; font-size: 1.5rem; font-weight: 700; display: block; line-height: 1.1; transition: color 0.5s; }
        @keyframes flashGreen { 0% { color: #10b981; } 100% { color: var(--text-primary); } }
        @keyframes flashRed { 0% { color: #ef4444; } 100% { color: var(--text-primary); } }
        .flash-up { animation: flashGreen 1s ease-out; }
        .flash-down { animation: flashRed 1s ease-out; }
        .price-change { font-weight: 700; font-size: 0.9rem; display: block; margin-top: 2px;}
        .data-meta { display: flex; flex-direction: column; align-items: flex-end; margin-top: 4px; gap: 2px; }
        .data-time { font-size: 0.65rem; color: #9ca3af; font-family: 'Roboto Mono', monospace; }
        .stale-badge { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-flex; align-items: center; gap: 3px; }

        .delete-btn { position: absolute; top: -10px; right: -8px; width: 24px; height: 24px; background: #fff; border-radius: 50%; border: 1px solid #e5e7eb; color: #9ca3af; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .delete-btn:hover { background: #fee2e2; color: #ef4444; border-color: #fecaca; }

        .holdings-row { background: #f9fafb; padding: 10px 20px; border-top: 1px dashed #e5e7eb; display: flex; align-items: center; justify-content: space-between; gap: 10px; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); }
        .holdings-input-group { display: flex; align-items: center; gap: 6px; }
        .holdings-label { font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; }
        .shares-input { width: 126px; padding: 4px 8px; font-size: 0.85rem; border-radius: 6px; border: 1px solid #d1d5db; }
        .holdings-val { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }

        .perf-row { display: none; }
        .metrics { display: none; }
        .risk-box { display: none; }
        .text-up { color: var(--col-up); } .text-down { color: var(--col-down); } .text-flat { color: var(--col-flat); }
        
        .loader { position: absolute; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        .pokeball { width: 40px; height: 40px; background: #fff; border: 3px solid #333; border-radius: 50%; position: relative; overflow: hidden; animation: shake 1.5s infinite ease-in-out; }
        .pokeball::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: #ef4444; border-bottom: 3px solid #333; }
        .pokeball::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: #fff; border: 3px solid #333; border-radius: 50%; z-index: 2; }
        .loading-text { font-size: 0.7rem; font-weight: 700; color: #6b7280; margin-top: 8px; }
        @keyframes shake { 0% { transform: rotate(0deg); } 20% { transform: rotate(-10deg); } 40% { transform: rotate(10deg); } 60% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

        @media (max-width: 768px) {
            header { flex-direction: column; align-items: stretch; padding: 16px; gap: 12px; }
            .header-left { justify-content: center; }
            .control-panel { justify-content: center; width: 100%; }
            .control-panel input { width: 80px; }
            .asset-panel { grid-template-columns: 1fr; gap: 16px; }
            .dashboard-grid { grid-template-columns: 1fr; } 
            .h-stats { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>

    <!-- WELCOME SCREEN -->
    <!-- Added onclick="manualEnter()" to enable clicking anywhere to enter -->
    <div id="welcome-screen" onclick="manualEnter()">
        <img src="welcome.jpg" alt="FAT FAT PIKA" class="welcome-img" onerror="this.style.display='none'">
        <!-- FIX 1: Quote Removed as requested -->
        <!-- Replaced button with simple text countdown -->
        <div id="countdown-text" class="countdown-text">Entering in 8...</div>
    </div>

    <header>
        <div class="header-left">
            <div class="logo-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                </svg>
            </div>
            <div class="title-group">
                <!-- FIX 2: Updated Title -->
                <h1>Wall Street <span>Pika</span></h1>
                <div class="subtitle">Mini Stock Dashboard</div>
            </div>
            <!-- Added Profile Pic -->
            <img src="pikaprofile.png" alt="Profile" class="profile-pic" onerror="this.style.display='none'">
        </div>

        <div class="control-panel">
            <!-- FIX 5: API Status on Top -->
            <span id="api-status-top" class="api-tag">Idle</span>
            
            <div id="global-status"></div>
            <select class="refresh-select" id="refresh-rate" onchange="changeRefreshRate(this.value)">
                <option value="60000" selected>‚è±Ô∏è 1m</option>
                <option value="300000">‚è±Ô∏è 5m</option>
                <option value="600000">‚è±Ô∏è 10m</option>
                <option value="900000">‚è±Ô∏è 15m</option>
                <option value="1800000">‚è±Ô∏è 30m</option>
                <option value="0">‚è±Ô∏è STOP</option>
            </select>
            <button class="btn btn-privacy" id="privacy-btn" onclick="togglePrivacy()" title="Privacy Mode">üëÅÔ∏è</button>
            <a href="https://sites.google.com/view/wallstreetpikabible/" target="_blank" class="btn btn-outline">üìñ ËÅñÁ∂ì</a>
            <input type="text" id="new-stock-input" placeholder="NVDA" maxlength="5">
            <button class="btn btn-primary" onclick="addNewStock()">+</button>
        </div>
    </header>

    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab-btn" onclick="switchTab('history')">History & Backup</div>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div class="asset-panel">
            <div class="ap-item">
                <span class="ap-label">Total (HKD)</span>
                <span class="ap-val p-mask" id="total-assets">HK$ --</span>
                <span class="ap-sub">Rate: <span id="fx-rate">7.78</span> (USD/HKD)</span>
            </div>
            <div class="ap-item">
                <span class="ap-label">Loan (HKD)</span>
                <input type="number" id="loan-input" class="ap-input" placeholder="0" onchange="updateLoan(this.value)">
            </div>
            <div class="ap-item">
                <span class="ap-label">Net Equity</span>
                <span class="ap-val net-val p-mask" id="net-value">HK$ --</span>
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <span class="ap-sub" id="lev-display">Lev: --</span>
                    <button class="snap-btn" onclick="event.stopPropagation(); takeSnapshot()">üì∑ Snap</button>
                </div>
            </div>
        </div>

        <div class="ticker-container">
            <div class="ticker-left-group">
                <div class="ticker-label">PIKA WISDOM</div>
                <button class="sound-btn" onclick="playPika()" title="Pika!">üîä</button>
            </div>
            <div class="ticker-content" id="ticker-content"></div>
        </div>

        <div class="dashboard-grid" id="app"></div>
    </div>

    <div id="view-history" class="view-section">
        <div class="data-tools">
            <button class="btn btn-outline" onclick="exportData()">‚¨áÔ∏è Export Data</button>
            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Import Data</button>
            <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">
        </div>
        <div class="history-list" id="history-container"></div>
    </div>

    <div style="text-align: center; margin-top: 40px; margin-bottom: 20px; color: #9ca3af; font-size: 0.7rem;">
        Mini Stock Dashboard <span id="api-status">| API: Idle</span>
    </div>

    <script>
        const API_KEY = 'd62qgopr01qnpu82ah0gd62qgopr01qnpu82ah10';
        const STORAGE_KEY = 'pika_dashboard_stable_v1';
        const LEGACY_KEYS = [
            'pika_stocks_v3_2', 'pika_stocks_v3_1', 'pika_stocks_v3_0', 
            'pika_stocks_v2_6', 'pika_stocks_v2_5', 'pika_stocks_v2_3'
        ];
        
        const DEFAULT_STOCKS = [
            { symbol: 'KEN', beta: 1.5, shares: 0 }, 
            { symbol: 'TSLA', beta: 2.4, shares: 0 }, 
            { symbol: 'UPST', beta: 2.8, shares: 0 }
        ];

        let marketData = [];
        let loanAmount = 0;
        let usdHkdRate = 7.78; 
        let snapshots = [];
        let isPrivacy = false; 
        
        let fetchQueue = [];
        let refreshInterval = 60000;
        let userIntervalTimer = null;
        let queueProcessorTimer = null;
        
        // Countdowns
        let welcomeTimer = null;
        let nextFetchTime = 0;
        let statusUpdateTimer = null;

        // --- Welcome Screen Logic ---
        function startWelcomeCountdown() {
            // FIX 2: 8 seconds
            let count = 8;
            const textEl = document.getElementById('countdown-text');
            
            welcomeTimer = setInterval(() => {
                count--;
                if (textEl) textEl.innerText = `Entering in ${count}...`;
                if (count <= 0) {
                    manualEnter();
                }
            }, 1000);
        }
        
        function manualEnter() {
            if (welcomeTimer) clearInterval(welcomeTimer);
            const screen = document.getElementById('welcome-screen');
            screen.style.opacity = '0';
            setTimeout(() => {
                screen.style.display = 'none';
            }, 500);
        }

        // Start Countdown on Load
        window.addEventListener('load', startWelcomeCountdown);

        function playPika() {
            if (!window.speechSynthesis) return;
            const speak = () => {
                const u = new SpeechSynthesisUtterance("Pika Pika!");
                u.pitch = 1.8; u.rate = 1.4; u.volume = 1;
                window.speechSynthesis.speak(u);
            };
            speak(); setTimeout(speak, 800); setTimeout(speak, 1600);
        }

        function initTicker() {
            const quotes = [
                "ËÉΩÂ§†Ëá™Áî±Ëá™Âú∞ÈÅéËëóÁ¨¶ÂêàËá™Â∑±ÁöÑÁÜ±Âø±ÂíåÁâπË≥™ÁöÑ‰∫∫ÁîüÔºåÂ§ßÊ¶ÇÂ∞±ÊòØÈáëÈå¢ÂèØ‰ª•Ë≤∑Âà∞ÁöÑÊúÄÂ§ßÂ•¢‰æàÂìÅ„ÄÇ",
                "‰∏ÄËº©Â≠êÊäìËëóÂπæÂÄãÊ©üÊúÉÔºåËøÖÈÄüË°åÂãïÔºåÂéªÂÅöÁ∞°ÂñÆÂèàÂêà‰πéÈÇèËºØÁöÑ‰∫ãÊÉÖÔºåÂ∞±ËÉΩÂæóÂà∞ÂæàÂ§ßÁöÑË≤°ÂØå„ÄÇ",
                "Ë≥∫Èå¢ÊòØÁÇ∫‰∫ÜÊõ¥Â•ΩÁöÑÁîüÊ¥ªÔºåÊàëÂÄëÂçªÂú®Ë≥∫Èå¢ÁöÑÈÅéÁ®ã‰∏≠ÈåØÈÅé‰∫ÜÁîüÊ¥ª",
                "Áü≠ÊúüÂÖßÂ∏ÇÂ†¥ÊòØÊäïÁ•®Ê©üÔºåÈï∑Êúü‰æÜÊòØ‰∏ÄÂè∞Á®±ÈáçÊ©ü",
                "ÊúÄÈáçË¶ÅÁöÑÊòØËÄêÊÄßÔºå‰∫§ÊòìÊ±∫Á≠ñÂÆúÁ∑©‰∏çÂÆúÊÄ•„ÄÇ"
            ];
            const el = document.getElementById('ticker-content');
            if (el) el.innerHTML = quotes.map(q => `<span class="ticker-item">‚òÖ ${q}</span>`).join('');
        }

        function getNyDateString(dateObj) {
            return new Intl.DateTimeFormat('en-US', { 
                timeZone: 'America/New_York', year: 'numeric', month: 'numeric', day: 'numeric' 
            }).format(dateObj);
        }

        function getMarketState() {
            const now = new Date();
            const nyTimeStr = now.toLocaleString("en-US", {timeZone: "America/New_York"});
            const nyTime = new Date(nyTimeStr);
            const day = nyTime.getDay();
            const hour = nyTime.getHours();
            const min = nyTime.getMinutes();
            const timeVal = hour + min/60;

            if (day === 0 || day === 6) return { code: 'CLOSED', label: 'MARKET CLOSED', color: 'closed' };
            if (timeVal >= 4 && timeVal < 9.5) return { code: 'PRE', label: 'PRE-MARKET', color: 'pre' };
            if (timeVal >= 9.5 && timeVal < 16) return { code: 'OPEN', label: 'MARKET OPEN', color: 'open' };
            if (timeVal >= 16 && timeVal < 20) return { code: 'POST', label: 'POST-MARKET', color: 'post' };
            return { code: 'CLOSED', label: 'MARKET CLOSED', color: 'closed' };
        }

        function updateGlobalStatus() {
            const state = getMarketState();
            const el = document.getElementById('global-status');
            if(el) el.innerHTML = `<span class="market-badge ${state.color}">${state.label}</span>`;
        }

        function exportData() {
            const data = {
                version: "3.7",
                date: new Date().toISOString(),
                stocks: marketData,
                loan: loanAmount,
                snapshots: snapshots,
                privacy: isPrivacy,
                refreshRate: refreshInterval
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pika_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.stocks && Array.isArray(data.stocks)) {
                        marketData = data.stocks;
                        loanAmount = data.loan || 0;
                        snapshots = data.snapshots || [];
                        isPrivacy = data.privacy || false;
                        refreshInterval = data.refreshRate || 60000;
                        
                        marketData.forEach(s => { s.loading = true; });
                        saveData();
                        
                        document.getElementById('refresh-rate').value = refreshInterval;
                        updatePrivacyUI(); 
                        document.getElementById('loan-input').value = loanAmount;
                        render(); 
                        renderHistory();
                        changeRefreshRate(refreshInterval); 
                        alert('Data Imported Successfully!');
                    } else { throw new Error("Invalid Format"); }
                } catch (err) { alert('Error: Invalid Backup File'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        const SmartStorage = {
            save: function(data, loan, snaps, privacy, rate) {
                const payload = {
                    stocks: data.map(s => ({ symbol: s.symbol, beta: s.beta || 1.2, perf: s.perf, shares: s.shares || 0 })),
                    loan: loan || 0,
                    snapshots: snaps || [],
                    privacy: privacy,
                    refreshRate: rate
                };
                const json = JSON.stringify(payload);
                try { localStorage.setItem(STORAGE_KEY, json); } catch(e){}
                try { sessionStorage.setItem(STORAGE_KEY, json); } catch(e){}
                try { window.name = json; } catch(e){}
            },
            load: function() {
                let json = null;
                try { json = localStorage.getItem(STORAGE_KEY); } catch(e){}
                if(!json) try { json = sessionStorage.getItem(STORAGE_KEY); } catch(e){}
                if(!json && window.name && window.name.startsWith('{')) { try { json = window.name; } catch(e){} }
                if (json) return JSON.parse(json);

                for (let key of LEGACY_KEYS) {
                    try {
                        let oldJson = localStorage.getItem(key) || sessionStorage.getItem(key);
                        if (oldJson) {
                            const parsed = JSON.parse(oldJson);
                            this.save(parsed.stocks || parsed, parsed.loan || 0, parsed.snapshots || [], parsed.privacy || false, 60000);
                            return parsed;
                        }
                    } catch(e) {}
                }
                return null;
            }
        };

        function loadStocks() {
            const saved = SmartStorage.load();
            if (saved && (saved.stocks || Array.isArray(saved))) {
                const dataRaw = saved.stocks || saved; 
                if (Array.isArray(dataRaw)) {
                    marketData = dataRaw;
                    loanAmount = saved.loan || 0;
                    snapshots = saved.snapshots || [];
                    isPrivacy = saved.privacy || false;
                    refreshInterval = saved.refreshRate || 60000;
                    marketData.forEach(s => { s.loading = true; });
                }
            } else {
                marketData = JSON.parse(JSON.stringify(DEFAULT_STOCKS));
                marketData.forEach(s => { s.loading = true; });
                loanAmount = 0;
                snapshots = [];
            }
            
            document.getElementById('loan-input').value = loanAmount;
            const rateSel = document.getElementById('refresh-rate');
            if([...rateSel.options].some(o => o.value == refreshInterval)) {
                rateSel.value = refreshInterval;
            } else {
                rateSel.value = 60000;
                refreshInterval = 60000;
            }

            updatePrivacyUI();
            render();
            fetchFxRate();
            startQueueSystem(); 
        }

        function saveData() {
            SmartStorage.save(marketData, loanAmount, snapshots, isPrivacy, refreshInterval);
            calculateAssets();
        }

        async function addNewStock() {
            const input = document.getElementById('new-stock-input');
            const sym = input.value.trim().toUpperCase();
            if (!sym) return;
            if (marketData.find(s => s.symbol === sym)) {
                alert('Symbol already exists');
                return;
            }
            
            const newStock = { symbol: sym, beta: 1.5, loading: true, shares: 0 };
            
            try {
                const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`);
                const data = await res.json();
                
                if (!data || data.c === 0) {
                     alert(`Invalid Symbol: ${sym}`);
                     return;
                }
                
                marketData.push(newStock);
                saveData();
                input.value = '';
                render();
                fetchSingle(newStock);
                
            } catch(e) {
                alert("Error validating stock");
            }
        }

        function removeStock(sym) {
            marketData = marketData.filter(s => s.symbol !== sym);
            saveData();
            render();
        }

        function updateShares(sym, val) {
            const stock = marketData.find(s => s.symbol === sym);
            if (stock) { stock.shares = parseFloat(val) || 0; saveData(); render(); }
        }

        function updateLoan(val) {
            loanAmount = parseFloat(val) || 0;
            saveData();
        }

        function togglePrivacy() {
            isPrivacy = !isPrivacy;
            updatePrivacyUI();
            saveData();
            render();
        }

        function updatePrivacyUI() {
            const btn = document.getElementById('privacy-btn');
            const loanInput = document.getElementById('loan-input');
            if (isPrivacy) {
                btn.classList.add('active');
                loanInput.type = "password";
            } else {
                btn.classList.remove('active');
                loanInput.type = "number";
            }
            calculateAssets();
        }

        function changeRefreshRate(val) {
            refreshInterval = parseInt(val);
            saveData(); 
            if (userIntervalTimer) clearInterval(userIntervalTimer);
            
            // Set next Fetch Target Time for visual countdown
            if (refreshInterval > 0) {
                nextFetchTime = Date.now() + refreshInterval;
                userIntervalTimer = setInterval(refillQueue, refreshInterval);
                // Trigger refil immediately? No, wait for cycle.
                // Or maybe trigger once now.
                refillQueue(); 
            } else {
                nextFetchTime = 0;
            }
            updateStatusUI();
        }

        function startQueueSystem() {
            if (queueProcessorTimer) clearInterval(queueProcessorTimer);
            queueProcessorTimer = setInterval(processQueue, 1500);
            
            // Start Visual Timer updater
            if (statusUpdateTimer) clearInterval(statusUpdateTimer);
            statusUpdateTimer = setInterval(updateStatusUI, 1000);

            changeRefreshRate(refreshInterval);
        }

        // FIX 5: Visual Countdown Logic
        function updateStatusUI() {
            const el = document.getElementById('api-status-top');
            if (!el) return;

            // If processing
            if (fetchQueue.length > 0) {
                el.innerText = `Processing (${fetchQueue.length})`;
                el.classList.add('active');
                return;
            }

            el.classList.remove('active');

            if (refreshInterval === 0) {
                el.innerText = 'Stopped';
                return;
            }

            // Idle countdown
            const now = Date.now();
            if (nextFetchTime > now) {
                const diff = Math.ceil((nextFetchTime - now) / 1000);
                el.innerText = `Idle (${diff}s)`;
            } else {
                el.innerText = 'Idle (0s)';
            }
        }

        function refillQueue() {
            marketData.forEach(stock => {
                if (!fetchQueue.includes(stock)) {
                    fetchQueue.push(stock);
                }
            });
            // Reset next target time
            if (refreshInterval > 0) {
                nextFetchTime = Date.now() + refreshInterval;
            }
            updateStatusUI();
        }

        async function processQueue() {
            if (fetchQueue.length === 0) return;
            const stock = fetchQueue.shift();
            updateStatusUI();
            await fetchSingle(stock);
        }

        async function fetchSingle(stock) {
            try {
                const bust = Date.now();
                const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stock.symbol}&token=${API_KEY}&_=${bust}`);
                
                if (res.status === 429) {
                    console.warn("Rate limit hit");
                    fetchQueue.push(stock); 
                    return;
                }
                const data = await res.json();

                if (data.c) {
                    const prevPrice = stock.currentPrice; 
                    stock.prevClose = data.pc; 
                    stock.lastUpdate = data.t;
                    stock.loading = false;

                    const todayNyStr = getNyDateString(new Date()); 
                    const dataNyStr = getNyDateString(new Date(data.t * 1000));
                    stock.isStale = (dataNyStr !== todayNyStr);

                    if (stock.isStale) {
                        stock.currentPrice = data.c; 
                        stock.changePercent = data.dp; 
                    } else {
                        stock.currentPrice = data.c;
                        if (data.pc > 0) {
                            stock.changePercent = ((data.c - data.pc) / data.pc) * 100;
                        } else {
                            stock.changePercent = data.dp;
                        }
                    }

                    // No perf stats needed
                    // Simple RSI logic removed or kept minimal if needed for risk calc
                    let base = 50 + (stock.changePercent * 2);
                    stock.rsi = Math.min(Math.max(base + (Math.random()*4-2), 10), 90);
                    
                    calculateAssets(); 
                    
                    const priceEl = document.getElementById(`price-val-${stock.symbol}`);
                    if (priceEl) {
                        priceEl.innerText = `$${stock.currentPrice.toFixed(2)}`;
                        if (prevPrice && prevPrice !== stock.currentPrice) {
                            const flashClass = stock.currentPrice > prevPrice ? 'flash-up' : 'flash-down';
                            priceEl.classList.remove('flash-up', 'flash-down');
                            void priceEl.offsetWidth; 
                            priceEl.classList.add(flashClass);
                        }
                    } else {
                        render();
                    }
                    
                    render();
                }
            } catch (e) { console.error(e); }
        }

        function calculateRisk(stock) {
            let score = 0;
            const beta = stock.beta || 1.2;
            if (beta > 2.0) score += 30; else if (beta > 1.5) score += 20; else score += 10;
            const rsi = stock.rsi || 50;
            if (rsi > 75 || rsi < 25) score += 20;
            const absChg = Math.abs(stock.changePercent || 0);
            if (absChg > 5.0) score += 30; else if (absChg > 2.0) score += 15;
            return Math.min(Math.max(Math.round(score), 5), 100);
        }

        function getSign(val) { return parseFloat(val) > 0 ? '+' : ''; }
        function getColor(val) { return parseFloat(val) >= 0 ? 'text-up' : 'text-down'; }

        async function fetchFxRate() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                if (data && data.rates && data.rates.HKD) {
                    usdHkdRate = data.rates.HKD;
                    document.getElementById('fx-rate').innerText = usdHkdRate.toFixed(3);
                    calculateAssets();
                }
            } catch(e) {}
        }

        function calculateAssets() {
            let totalUsd = 0;
            marketData.forEach(s => {
                const price = s.currentPrice || 0;
                const qty = s.shares || 0;
                totalUsd += price * qty;
            });

            const totalHkd = totalUsd * usdHkdRate;
            const netHkd = totalHkd - loanAmount;
            
            let lev = 0;
            if (netHkd > 0) { lev = (totalHkd / netHkd); } 
            else if (totalHkd > 0) { lev = 999; }

            const totalEl = document.getElementById('total-assets');
            const netEl = document.getElementById('net-value');
            
            if (isPrivacy) {
                totalEl.innerText = "HK$ ****";
                netEl.innerText = "HK$ ****";
                totalEl.classList.add('mask-text');
                netEl.classList.add('mask-text');
            } else {
                totalEl.innerText = 'HK$ ' + Math.round(totalHkd).toLocaleString();
                netEl.innerText = 'HK$ ' + Math.round(netHkd).toLocaleString();
                totalEl.classList.remove('mask-text');
                netEl.classList.remove('mask-text');
            }
            
            const levStr = lev === 999 ? "Risk" : lev.toFixed(2) + "x";
            const levEl = document.getElementById('lev-display');
            levEl.innerText = "Lev: " + levStr;
            
            if(lev > 1.5) levEl.style.color = '#f87171'; 
            else if(lev > 1.2) levEl.style.color = '#fbbf24'; 
            else levEl.style.color = '#94a3b8'; 
            
            return { total: totalHkd, net: netHkd, lev: levStr };
        }

        function takeSnapshot() {
            const now = new Date();
            const timeStr = now.toLocaleString("zh-HK", { hour12: false });
            const assets = calculateAssets(); 
            
            let totalUsd = 0;
            marketData.forEach(s => { totalUsd += (s.currentPrice || 0) * (s.shares || 0); });
            const realTotal = totalUsd * usdHkdRate;
            const realNet = realTotal - loanAmount;
            
            const snap = {
                id: Date.now(),
                time: timeStr,
                net: Math.round(realNet).toLocaleString(),
                total: Math.round(realTotal).toLocaleString(),
                loan: Math.round(loanAmount).toLocaleString(),
                lev: assets.lev, 
                details: marketData.map(s => ({
                    sym: s.symbol,
                    shares: s.shares || 0,
                    price: s.currentPrice || 0
                }))
            };
            
            snapshots.unshift(snap); 
            if(snapshots.length > 20) snapshots.pop(); 
            saveData();
            if(document.getElementById('view-history').classList.contains('active')) renderHistory();
            alert('Snapshot Saved!');
        }

        function deleteSnapshot(id) {
            if(!confirm('Delete this record?')) return;
            snapshots = snapshots.filter(s => s.id !== id);
            saveData();
            renderHistory();
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(tab === 'dashboard') btns[0].classList.add('active');
            else {
                btns[1].classList.add('active');
                renderHistory();
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(snapshots.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:40px;">No snapshots yet.</div>';
                return;
            }
            container.innerHTML = snapshots.map(s => `
                <div class="history-card" onclick="this.classList.toggle('open')">
                    <div class="h-time">${s.time}</div>
                    <div class="h-stats">
                        <div class="h-stat-item">
                            <span class="h-label">Net Asset</span>
                            <span class="h-val net">HK$ ${s.net}</span>
                        </div>
                        <div class="h-stat-item">
                            <span class="h-label">Lev</span>
                            <span class="h-val" style="font-size:0.9rem">${s.lev || '-'}</span>
                        </div>
                    </div>
                    <div class="h-actions">
                        <button class="toggle-btn">Details</button>
                        <button class="del-hist-btn" onclick="event.stopPropagation(); deleteSnapshot(${s.id})">‚úï</button>
                    </div>
                    <div class="h-details" onclick="event.stopPropagation()">
                        <div class="h-stock-row" style="font-weight:700; color:#6b7280;">
                            <span>Stock</span><span>Price(USD)</span><span>Shares</span>
                        </div>
                        ${s.details.map(d => `
                            <div class="h-stock-row">
                                <span>${d.sym}</span>
                                <span>$${d.price.toFixed(2)}</span>
                                <span>${d.shares}</span>
                            </div>
                        `).join('')}
                        <div class="h-stock-row" style="margin-top:8px; font-weight:700;">
                            <span>Loan</span><span></span><span>- HK$ ${s.loan}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function render() {
            const container = document.getElementById('app');
            const state = getMarketState();

            container.innerHTML = marketData.map(stock => {
                const p = stock.currentPrice ? stock.currentPrice.toFixed(2) : '--';
                const cp = stock.changePercent ? stock.changePercent.toFixed(2) : '0.00';
                
                let cClass = stock.changePercent >= 0 ? 'text-up' : 'text-down';
                if (stock.isStale) cClass = 'text-flat'; 
                
                const sign = stock.changePercent >= 0 ? '+' : '';
                
                let timeDisplay = '--:--';
                if (stock.lastUpdate) {
                    timeDisplay = new Date(stock.lastUpdate * 1000).toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});
                }
                
                let timeHtml = `<div class="data-meta"><span class="data-time">Update: ${timeDisplay} ET</span></div>`;
                if (stock.isStale) {
                    if (state.code !== 'CLOSED') {
                        timeHtml = `
                        <div class="data-meta">
                            <span class="stale-badge">‚ö†Ô∏è Waiting for trade</span>
                            <span class="data-time">Last: ${timeDisplay}</span>
                        </div>`;
                    } else {
                        timeHtml = `<div class="data-meta"><span class="data-time">Closed: ${timeDisplay}</span></div>`;
                    }
                }

                let riskScore = calculateRisk(stock);
                let riskColor = 'var(--risk-med)';
                if(riskScore < 35) { riskColor = 'var(--risk-low)'; }
                if(riskScore > 65) { riskColor = 'var(--risk-high)'; }

                const shares = stock.shares || 0;
                const priceVal = stock.currentPrice || 0;
                const holdingValUsd = shares * priceVal;
                const holdingValHkd = holdingValUsd * usdHkdRate;
                
                let holdingDisplay = `HK$ ${Math.round(holdingValHkd).toLocaleString()}`;
                let sharesInputType = "number";
                if (isPrivacy) { holdingDisplay = "HK$ ****"; sharesInputType = "password"; }

                const loadingHtml = stock.loading ? `
                    <div class="loader">
                        <div class="pokeball"></div>
                        <div class="loading-text">ËºâÂÖ•‰∏≠...</div>
                    </div>` : '';

                return `
                <div class="card">
                    ${loadingHtml}
                    <!-- FIX 2: Delete Button Moved to Edge -->
                    <button class="delete-btn" onclick="removeStock('${stock.symbol}')">‚úï</button>
                    
                    <div class="card-top">
                        <div class="stock-info">
                            <span class="market-tag ${state.color}">${state.code}</span>
                            <h2>${stock.symbol}</h2>
                        </div>
                        <div class="price-group">
                            <span class="price-val" id="price-val-${stock.symbol}">$${p}</span>
                            <span class="price-change ${cClass}">${sign}${cp}%</span>
                            ${timeHtml}
                        </div>
                    </div>

                    <div class="holdings-row">
                        <div class="holdings-input-group">
                            <span class="holdings-label">Shares</span>
                            <input type="${sharesInputType}" class="shares-input" value="${shares}" onchange="updateShares('${stock.symbol}', this.value)">
                        </div>
                        <div class="holdings-val ${isPrivacy?'mask-text':''}">
                            ${holdingDisplay}
                        </div>
                    </div>

                    <!-- Clean UI: No Risk Score Bar -->
                </div>`;
            }).join('');
        }

        initTicker();
        loadStocks();
        setInterval(updateGlobalStatus, 60000);

    </script>
</body>
</html>
